version: "3.8"

services:
  # ===========================================
  # Combined service (Node.js + Python)
  # Use this for single-container deployment
  # ===========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Pass .env variables as build args to Dockerfile
        - FINNHUB_API_KEY=${FINNHUB_API_KEY}
        - GOOGLE_API_KEY=${GOOGLE_API_KEY}
        - FRED_API_KEY=${FRED_API_KEY}
        - NODE_ENV=${NODE_ENV:-production}
        - ENVIRONMENT=${ENVIRONMENT:-production}
        - NODE_PORT=${NODE_PORT:-3000}
        - PYTHON_PORT=${PYTHON_PORT:-3001}
        - SESSION_DURATION=${SESSION_DURATION:-300}
        - COOLDOWN_DURATION=${COOLDOWN_DURATION:-300}
        - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
        - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60}
        - USE_YFINANCE_EXTRAS=${USE_YFINANCE_EXTRAS:-false}
    # Map container ports to host ports
    ports:
      - "3000"
      - "3001"
    environment:
      # ===========================================
      # API Keys (read from .env file)
      # ===========================================
      - FINNHUB_API_KEY=${FINNHUB_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - FRED_API_KEY=${FRED_API_KEY}
      # ===========================================
      # Server Configuration
      # ===========================================
      - NODE_ENV=${NODE_ENV:-production}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - NODE_PORT=${NODE_PORT:-3000}
      - PYTHON_PORT=${PYTHON_PORT:-3001}
      # ===========================================
      # Rate Limiting
      # ===========================================
      - SESSION_DURATION=${SESSION_DURATION:-300}
      - COOLDOWN_DURATION=${COOLDOWN_DURATION:-300}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60}
      # ===========================================
      # Feature Flags
      # ===========================================
      - USE_YFINANCE_EXTRAS=${USE_YFINANCE_EXTRAS:-false}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
# ===========================================
# Alternative: Separate services
# Uncomment below if you prefer separate containers
# ===========================================
#   nodejs:
#     build:
#       context: .
#       dockerfile: Dockerfile.node
#     ports:
#       - "3000:3000"
#     env_file:
#       - .env
#     environment:
#       - NODE_ENV=production
#     depends_on:
#       - python
#     restart: unless-stopped
#
#   python:
#     build:
#       context: .
#       dockerfile: Dockerfile.python
#     ports:
#       - "3001:3001"
#     env_file:
#       - .env
#     environment:
#       - ENVIRONMENT=production
#     restart: unless-stopped

